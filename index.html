<html>
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" href="style.css" />
<title>Morse</title>
</head>
<script>

var url = "rest.php"; 
var text = "";
var morse_text = ""; // morse version, will be used for async shit
var morse_array = [];


var speed = 25; // in wpm
// T(ms) = 1200 / W(wpm)
var speed_change = 0; // will change to -1 if decreasing
var speed_direction = 1; // 1 for more, -1 for less


function code(letter) {
	switch (letter) {
		case 'A': out = '.-'; break;
		case 'B': out = '-...'; break;
		case 'C': out = '-.-.'; break;
		case 'D': out = '-..'; break;
		case 'E': out = '.'; break;
		case 'F': out = '..-.'; break;
		case 'G': out = '--.'; break;
		case 'H': out = '....'; break;
		case 'I': out = '..'; break;
		case 'J': out = '.---'; break;
		case 'K': out = '-.-'; break;
		case 'L': out = '.-..'; break;
		case 'M': out = '--'; break;
		case 'N': out = '-.'; break;
		case 'O': out = '---'; break;
		case 'P': out = '.--.'; break;
		case 'Q': out = '--.-'; break;
		case 'R': out = '.-.'; break;
		case 'S': out = '...'; break;
		case 'T': out = '-'; break;
		case 'U': out = '..-'; break;
		case 'V': out = '...-'; break;
		case 'W': out = '.--'; break;
		case 'X': out = '-..-'; break;
		case 'Y': out = '-.--'; break;
		case 'Z': out = '--..'; break;
		case '0': out = '-----'; break;
		case '1': out = '.----'; break;
		case '2': out = '..---'; break;
		case '3': out = '...--'; break;
		case '4': out = '....-'; break;
		case '5': out = '.....'; break;
		case '6': out = '-....'; break;
		case '7': out = '--...'; break;
		case '8': out = '---..'; break;
		case '9': out = '----.'; break;
		case '.': out = '.-.-.-'; break;
		case ',': out = '--..--'; break;
		case '?': out = '..--..'; break;
		case "'": out = '.----.'; break;
		case '!': out = '-..-.'; break;
		case '(': out = '-.--.'; break;
		case ')': out = '-.--.-'; break;
		case '&': out = '.-...'; break;
		case ':': out = '---...'; break;
		case ';': out = '-.-.-.'; break;
		case '=': out = '-...-'; break;
		case '+': out = '.-.-.'; break;
		case '-': out = '-....-'; break;
		case '_': out = '..--.-'; break;
		case '"': out = '.-..-.'; break;
		case '$': out = '...-..-'; break;
		case '@': out = '.--.-.'; break;
		case ' ': out = '/'; break;
		default: out = '/'; break;
	} 
	return out;
}

function display_state(state) {
	item = document.getElementById('state');
	item.innerHTML = state;
}

function sleep(ms) {
	  return new Promise(resolve => setTimeout(resolve, ms));
}


async function off(method, delay) {
	console.log('off for ' + delay);
	await sleep(delay);
}

async function on(method, delay) {
	console.log('on for ' + delay);
	if (method == 0) {
		// sound here
	}
	if (method == 2) {
		display_block(1, 1);
		await sleep(delay);
		display_block(1, 0);

	}
}


// i would like to convert that to an array of things to do
// array would be like 
// 1 200
// 0 200
// 1 300
// etc
// so that i would just have to have a cursor, and be able to go super full async like a master


function display_block(here, visible) {
	if (here == 0) {
		document.getElementById('morse_as_block').style.display = "none"; 
	}
	else { 
		document.getElementById('morse_as_block').style.display = "block";
	}
	if (visible == 0) {
		document.getElementById('morse_as_block').style.visibility = "hidden"; 
	}
	else { 
		document.getElementById('morse_as_block').style.visibility = "visible"; 
	} 

}


function convert_to_array(morse) {
	// in morse, i have something like
	//      .-- .... .- - / - .... . / ..-. ..- -.-. -.-

	// delay to wayt = 0

	// if i have a ., i play delay, reset it, play tic, and tic will be added to delay
	// if i have a -, i play delay, reset it, play 3tic, and tic will be added to delay
	// if i have a  , i add 3tic to delay
	// if i have a /, i add 1tic to delay




}

function convert_to_morse(text) {
	r = '';
	for (var i = 0, len = text.length; i < len; i++) { 
		letter = text[i].toUpperCase();
		r = r + code(letter) + ' '; 
	}
	return r;
}

function display_morse() {
	item = document.getElementById('morse_as_text');
	item.innerHTML = morse_text; 
}


async function play(method) {
	// method :
	// 0 : bip
	// 1 : display as text
	// 2 : flash some block on the screen

	tic = 1200 / speed; // tic is in ms
	console.log('speed = ' + speed);
	console.log('tic = ' + tic);

	if (method == 1) { reset_morse_as_text(); }
	if (method == 2) { display_block(1, 0); }

	duration_off = 0; // pause before the signal, depends of the last char

	for (var i = 0, len = text.length; i < len; i++) {
		// note : if letter = ' ', then special pause


		letter = text[i].toUpperCase();
		c = code(letter);
		if (method == 1) {
			append_morse_as_text(c + ' ');
		}
		else {
			if (c == " ") { off(method, 7 * tic); } // 7 but minus 3 because the character space was already off
			else { 

				if (i > 0) {
					off(method, 3 * tic); } 
				
				for (var j = 0, lenj = c.length; i < len; i++) {

					if (j > 0) {
						off(method, tic)
					}

					d = c[i];
					if (d == '.') {
						on(method, tic);
					}
					if (d == '-') {
						on(method, tic * 3);
					}
				}
				off(method, 2); // 3 minus the b

			} 
		} 

	}

}

function display_speed() {
	item = document.getElementById('speed');
	item.innerHTML = 'speed = ' + speed;
}

function display() {
	item = document.getElementById('text');
	item.innerHTML = text;
	display_state('displayed'); 
}

function remove() {
	item = document.getElementById('text');
	item.innerHTML = "";
}

function store(datas) {
	text = datas['val'];
	morse_text = convert_to_morse(text);
	display_state('loaded');
} 

function do_speed_change(direction) {
	if (speed_direction != direction) {
		speed_direction = direction;
		speed_change =0; }
	switch (speed_change) {
		case 0: speed_change=1;break;
		case 1: speed_change=2;break;
		case 2: speed_change=5;break;
		case 5: speed_change=10;break;
	}
	speed = speed + (speed_change * direction); 
	if (speed < 1) { speed = 1; }
	if (speed > 1000) { speed = 1000; }
	display_speed();
}

function slower() {
	do_speed_change(-1)
}

function faster() {
	do_speed_change(1)
}

function do_default_speed() {
	speed = 25;
	speed_direction = 0;
	display_speed();
}

function get_new() {
	display_state('loading');
	remove();
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var datas = JSON.parse(this.responseText);
			store(datas);
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
}



function test1() {
	display_block(0,0);
} 
function test2() {
	display_block(0,1);
}
function test3() {
	display_block(1,0);
}
function test4() {
	display_block(1,1);
}


window.onload = function() {
	display_state('ready');
	display_speed();
	//document.getElementById('morse_as_block').style.visibility = "hidden";
	//document.getElementById('morse_as_block').style.display = "none";
	// TODO hide block
}



</script> 

<body>
<div id="state"></div>
<div id="speed"></div>
<i><div id="text"></div></i>
<h1><div id="morse_as_text"></div></h1>
<div id="morse_as_block" class="box black"></div>

<br/>
<button onclick="get_new()">Load</button><br/> 
<button onclick="play(0)">Play</button><br/> 
<button onclick="display_morse()">Display</button><br/> 
<button onclick="play(2)">Flash</button><br/> 
<button onclick="display()">Reveal</button><br/> 
<button onclick="do_default_speed()">Default speed</button><br/>
<button onclick="slower()">Slower</button><br/> 
<button onclick="faster()">Faster</button><br/> 
<br/>
<button onclick="test1()">test 1</button><br/> 
<button onclick="test2()">test 2</button><br/> 
<button onclick="test3()">test 3</button><br/> 
<button onclick="test4()">test 4</button><br/> 
</body>
</html>
